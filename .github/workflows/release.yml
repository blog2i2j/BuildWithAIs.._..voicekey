name: Build & Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  # 1. å‡†å¤‡å‘å¸ƒï¼šç”Ÿæˆç‰ˆæœ¬å·ã€Changelogã€æ‰“ Tag
  prepare-release:
    runs-on: ubuntu-latest
    # åªæœ‰æ‰‹åŠ¨è§¦å‘æ—¶æ‰è¿è¡Œæ­¤æ­¥éª¤
    if: github.event_name == 'workflow_dispatch'
    outputs:
      new_tag: ${{ steps.get_tag.outputs.tag }}
      changelog: ${{ steps.extract_changelog.outputs.notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version and push
        run: |
          npm ci
          # è¿è¡Œ standard-version æ›´æ–°ç‰ˆæœ¬å’Œ Changelog
          npx standard-version --release-as ${{ inputs.release_type }}

          # æ¨é€ commits å’Œ tags åˆ° main
          git push --follow-tags origin HEAD:main

      - name: Get new tag
        id: get_tag
        run: |
          # è·å–æœ€æ–°çš„ tag
          TAG=$(git describe --tags --abbrev=0)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated new tag: $TAG"

      - name: Extract Changelog
        id: extract_changelog
        run: |
          # æå–æœ€æ–°ç‰ˆæœ¬çš„ Changelog å†…å®¹
          CHANGELOG_CONTENT=$(node .github/scripts/extract-changelog.js)

          # å¤„ç†å¤šè¡Œæ–‡æœ¬è¾“å‡ºåˆ° GITHUB_OUTPUT
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # 2. æ„å»º macOS
  build-mac:
    needs: [prepare-release]
    strategy:
      matrix:
        include:
          - os: macos-15-intel
            arch: x64
            args: --x64
          - os: macos-latest
            arch: arm64
            args: --arm64
    runs-on: ${{ matrix.os }}
    env:
      CSC_IDENTITY_AUTO_DISCOVERY: 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.new_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build macOS app (unsigned)
        run: |
          npm run build -- \
            --mac ${{ matrix.args }} \
            -c.mac.identity=null \
            -c.mac.hardenedRuntime=false \
            --publish never

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-artifacts-${{ matrix.arch }}
          path: release/**/Voice*-Mac-*.dmg
          if-no-files-found: error

  # 3. æ„å»º Windows
  build-win:
    needs: [prepare-release]
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.new_tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Windows app (unsigned)
        run: npm run build -- --win --publish never

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win-artifacts
          path: release/**/Voice*-Windows-*-Setup.exe
          if-no-files-found: error

  # 4. å‘å¸ƒ Release
  release:
    needs: [prepare-release, build-mac, build-win]
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: mac-artifacts-*
          merge-multiple: true
          path: artifacts

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: win-artifacts
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.new_tag }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/Voice*-Mac-*.dmg
            artifacts/**/Voice*-Windows-*-Setup.exe
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒï¼

            **æ³¨æ„ï¼šæœ¬é¡¹ç›®æš‚æ— å•†ä¸šç­¾åè¯ä¹¦ï¼Œå®‰è£…æ—¶å¯èƒ½ä¼šæç¤ºå®‰å…¨è­¦å‘Šã€‚**

            ### ğŸ macOS ç”¨æˆ·
            åˆæ¬¡å®‰è£…å¯èƒ½å‡ºç° â€œåº”ç”¨å·²æŸåï¼Œæ— æ³•æ‰“å¼€â€ æˆ– â€œæ¥è‡ªèº«ä»½ä¸æ˜çš„å¼€å‘è€…â€ã€‚

            è¯·æ‰“å¼€ã€Œç»ˆç«¯ã€æ‰§è¡Œï¼š

            ```bash
            xattr -cr /Applications/Voice\ Key.app
            ```

            ### ğŸªŸ Windows ç”¨æˆ·
            å¦‚æœå‡ºç° SmartScreen æç¤ºï¼š

            1. ç‚¹å‡» â€œæ›´å¤šä¿¡æ¯â€
            2. ç‚¹å‡» â€œä»è¦è¿è¡Œâ€

            ---

            ### æ›´æ–°æ—¥å¿—
            ${{ needs.prepare-release.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
